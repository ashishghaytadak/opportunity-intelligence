# Salesforce CI/CD Pipeline for Opportunity Intelligence System
# Validates, tests, and deploys on push/PR to main branch

name: Salesforce CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Job 1: Validate and run tests (runs on every push and PR)
  validate-and-test:
    name: Validate & Test
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Node.js (required for Salesforce CLI)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Step 3: Install Salesforce CLI globally
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      # Step 4: Authenticate to Salesforce org using SFDX Auth URL
      # Secret SFDX_AUTH_URL must be set in GitHub repository secrets
      - name: Authenticate to Salesforce
        run: |
          echo ${{ secrets.SFDX_AUTH_URL }} | sf org login sfdx-url --alias org --set-default
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}

      # Step 5: Validate deployment (dry run) with local test execution
      - name: Validate deployment (dry run)
        run: sf project deploy start --dry-run --test-level RunLocalTests --wait 15

      # Step 6: Run Apex tests with code coverage
      # Target: 90%+ code coverage. RunLocalTests enforces org-level coverage on deploy.
      - name: Run Apex tests with coverage
        run: sf apex run test --code-coverage --result-format human --wait 15

  # Job 2: Deploy to Salesforce (runs only on push to main, after validation passes)
  deploy:
    name: Deploy to Salesforce
    runs-on: ubuntu-latest
    needs: validate-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Step 3: Install Salesforce CLI
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      # Step 4: Authenticate to Salesforce
      - name: Authenticate to Salesforce
        run: |
          echo ${{ secrets.SFDX_AUTH_URL }} | sf org login sfdx-url --alias org --set-default
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}

      # Step 5: Deploy to target org with test execution
      - name: Deploy to Salesforce org
        run: sf project deploy start --test-level RunLocalTests --wait 20
